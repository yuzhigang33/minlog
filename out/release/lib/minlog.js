// Generated by CoffeeScript 1.8.0
var MinLog, cwd, defaultAccessLogFile, fs, moment, os, path;

path = require('path');

fs = require('fs');

os = require('options-stream');

moment = require('moment');

cwd = process.cwd();

defaultAccessLogFile = "[" + cwd + "/logs/" + (path.basename(path.basename(process.argv[1], '.js'), '.coffee')) + "-]YYYY-MM-DD[.log]";

MinLog = (function() {
  function MinLog(options) {
    var fileName;
    this.options = os({
      duration: 2000,
      bufferLength: 0,
      fileName: defaultAccessLogFile
    }, options);
    this.log_day = moment().format('YYYY-MM-DD');
    this.buffer = [];
    fileName = moment().format(this.options.fileName);
    this.stream = this.newStream(fileName);
    this._checkFile();
    this._checkBuffer();
  }

  MinLog.prototype.newStream = function(fileName) {
    var stream;
    this.log_day = moment().format('YYYY-MM-DD');
    stream = fs.createWriteStream(fileName, {
      flags: 'a'
    });
    stream.on('error', function(e) {
      return console.error('log stream occur error', e);
    });
    stream.on('open', function() {});
    stream.on('close', function() {});
    return this.stream = stream;
  };

  MinLog.prototype.write = function(str) {
    this.buffer.push(str);
    if (this.buffer.length > this.options.bufferLength) {
      this.stream.write(this.buffer.join(''));
      return this.buffer.length = 0;
    }
  };

  MinLog.prototype.info = function(str) {
    var time;
    time = this._timeFormat();
    return this.write(time + ' ' + str + '\n');
  };

  MinLog.prototype._timeFormat = function() {
    var d, m, now, time, y;
    now = new Date;
    y = now.getFullYear();
    m = now.getMonth();
    m = m < 9 ? '0' + (m + 1) : m + 1;
    d = now.getDate();
    d = d < 10 ? '0' + d : d;
    time = now.toLocaleTimeString();
    return y + '-' + m + '-' + d + ' ' + time;
  };

  MinLog.prototype._checkFile = function() {
    var now, timeout;
    now = new Date;
    timeout = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1) - now;
    setTimeout(this._checkFile.bind(this), timeout);
    if (this.log_day !== moment().format('YYYY-MM-DD')) {
      this.stream.end();
      this.stream = null;
      return this.newStream(moment().format(this.options.fileName));
    }
  };

  MinLog.prototype._checkBuffer = function() {
    if (this.buffer.length !== 0) {
      this.stream.write(this.buffer.join(''));
      this.buffer.length = 0;
    }
    return setTimeout(this._checkBuffer.bind(this), this.options.duration);
  };

  return MinLog;

})();

module.exports = function(options) {
  return new MinLog(options);
};
